---
# Zarf Package Configuration for Dreadnode Platform
#
# This package uses the existing platform Helm chart from platform-charts
# and packages it for air-gapped deployment.
#
# USAGE:
#
# 1. Clone both repos side by side:
#    /path/to/
#      platform-charts/
#      sdk/
#
# 2. Build chart dependencies (if not already done):
#    cd /path/to/platform-charts/platform
#    helm dependency build
#
# 3. Create package (from connected environment):
#    cd /path/to/sdk/examples/airgap/zarf
#    zarf package create . --set VERSION=0.6.10 --confirm
#
# 4. Deploy package (air-gapped environment):
#    zarf package deploy zarf-package-dreadnode-platform-*.tar.zst --confirm

kind: ZarfPackageConfig
metadata:
  name: dreadnode-platform
  version: "###ZARF_PKG_TMPL_VERSION###"
  description: "Dreadnode Platform - Complete deployment with PostgreSQL, ClickHouse, MinIO"
  url: https://dreadnode.io
  authors: "Dreadnode Engineering Team"
  architecture: amd64

variables:
  - name: VERSION
    description: "Platform version to deploy"
    default: "0.6.10"

  - name: NAMESPACE
    description: "Kubernetes namespace for deployment"
    default: "dreadnode"

components:
  # ============================================================================
  # Dreadnode Platform (umbrella chart with all dependencies)
  # ============================================================================
  - name: platform
    description: "Complete Dreadnode platform including PostgreSQL, ClickHouse, MinIO, API, and UI"
    required: true

    charts:
      - name: platform
        # Relative path from this zarf.yaml to platform-charts/platform
        # Assumes repos are cloned side by side: platform-charts/ and sdk/
        localPath: ../../../../platform-charts/platform
        namespace: "###ZARF_VAR_NAMESPACE###"
        version: "###ZARF_PKG_TMPL_VERSION###"
        valuesFiles:
          - values-airgap.yaml

    # Container images required by the platform
    # Zarf will pull these and include them in the package
    images:
      # Platform services (from GHCR)
      - "ghcr.io/dreadnode/platform-api:###ZARF_PKG_TMPL_VERSION###"
      - "ghcr.io/dreadnode/platform-ui:###ZARF_PKG_TMPL_VERSION###"

      # PostgreSQL (Bitnami - matches platform-base Chart.yaml)
      - "docker.io/bitnami/postgresql:16-debian-12"

      # ClickHouse (matches platform values.yaml)
      - "docker.io/clickhouse/clickhouse-server:24.8-alpine"

      # MinIO (from min.io chart)
      - "docker.io/minio/minio:RELEASE.2024-01-18T22-51-28Z"
      - "docker.io/minio/mc:RELEASE.2024-01-18T07-03-39Z"

      # DynamoDB Local (for Crucible mode)
      - "docker.io/amazon/dynamodb-local:latest"

    actions:
      onDeploy:
        after:
          - wait:
              cluster:
                kind: pod
                name: app.kubernetes.io/name=postgresql
                namespace: "###ZARF_VAR_NAMESPACE###"
                condition: ready
            maxTotalSeconds: 300
            description: "Waiting for PostgreSQL"
          - wait:
              cluster:
                kind: pod
                name: app.kubernetes.io/name=clickhouse
                namespace: "###ZARF_VAR_NAMESPACE###"
                condition: ready
            maxTotalSeconds: 300
            description: "Waiting for ClickHouse"
          - wait:
              cluster:
                kind: pod
                name: app.kubernetes.io/name=minio
                namespace: "###ZARF_VAR_NAMESPACE###"
                condition: ready
            maxTotalSeconds: 300
            description: "Waiting for MinIO"
          - wait:
              cluster:
                kind: pod
                name: app.kubernetes.io/component=api
                namespace: "###ZARF_VAR_NAMESPACE###"
                condition: ready
            maxTotalSeconds: 300
            description: "Waiting for Platform API"
